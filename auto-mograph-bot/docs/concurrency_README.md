# 并发调度指南

本说明文档介绍了 `scheduler` 模块中的显存感知并发控制策略、配置方法与注意事项。

## 配置参数

在 `configs/default.yaml` 中，`scheduler` 段落新增了以下关键字段：

- `concurrency`：期望的并发任务数。系统会根据显存与 CPU 核心数自动调整该值。
- `min_free_vram_mb`：单个任务运行前所需的最小空闲显存（单位：MB）。
- `hard_serial`：当显存不足时是否强制降级为串行运行。
- `lock_path`：文件锁的存储路径，用于确保多实例之间的互斥。

其余字段（`batch_size`、`max_retries`、`cooldown_sec` 等）保持兼容，可按需调整。

## 自动降级逻辑

调度器会在任务执行前检测当前可用显存与 CPU 核心数：

1. 若检测到 GPU，但空闲显存小于 `min_free_vram_mb * concurrency`，且 `hard_serial` 为 `true`，则强制串行执行。
2. 若运行环境处于 CPU 模式或未能检测到 GPU，同样会降级为串行，并输出明确的日志提示。
3. 若 GPU 资源充足，但 CPU 物理核心数少于请求的并发度，会自动缩减到核心数对应的最大并发值。
4. 所有资源决策都会以结构化日志的形式记录，方便排查性能瓶颈。

## 文件锁机制

`scheduler` 在提交任务时会使用 `locks.py` 中的 `FileLock`：

- 每个任务在实际运行前都会占用锁文件，确保多实例不会在同一时间段竞争显卡。
- 锁文件为纯文本文件，默认路径为 `locks/gpu.lock`，可在配置中自定义。
- 若在指定 `timeout` 内无法获取锁，会抛出超时异常，建议在外层捕获后适当重试。

## 性能调优建议

- 合理设置 `min_free_vram_mb`，避免因显存紧张导致频繁降级。
- 在多 GPU 环境中建议拆分为多个进程，每个进程绑定单块显卡，以充分利用资源。
- 如果确定任务对显存占用较小，可适当提高 `concurrency`，但仍建议保留文件锁以防多实例竞争。
- 日志输出位置可在 `scheduler.log_dir` 中调整，结合结构化日志快速定位性能瓶颈。

## 合规声明

本项目及相关脚本不会生成任何二进制文件、模型权重或多媒体样例；新增的锁文件亦为纯文本格式，完全满足安全合规要求。
